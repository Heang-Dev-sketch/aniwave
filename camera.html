<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Night Vision Camera V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Kantumruy Pro', 'Battambang', sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden;
            touch-action: none; /* បិទការ Zoom របស់ Browser */
        }
        
        .camera-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas {
            z-index: 10;
            /* Filter នេះជួយឱ្យមើលឃើញក្នុងទីងងឹតបានច្បាស់ជាងមុន */
            filter: brightness(1.2) contrast(1.1); 
        }

        /* UI Overlay */
        .ui-layer {
            position: absolute;
            inset: 0;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-col;
            justify-content: space-between;
            padding: 20px;
        }

        .pointer-auto { pointer-events: auto; }
    </style>
</head>
<body>

    <div class="camera-container">
        <!-- វីដេអូដើម (លាក់វាទុក យើងបង្ហាញតែ Canvas ទេ) -->
        <video id="video-feed" autoplay playsinline muted class="hidden"></video>
        
        <!-- Canvas សម្រាប់បង្ហាញរូប -->
        <canvas id="thermal-canvas"></canvas>

        <!-- UI -->
        <div class="ui-layer flex flex-col justify-between h-full">
            
            <!-- Header -->
            <div class="flex justify-between items-start pointer-auto">
                <div class="bg-black/60 backdrop-blur rounded px-3 py-1 border border-purple-500/30">
                    <div class="flex items-center gap-2 text-purple-300">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                        <span class="text-xs font-bold">NIGHT VISION</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1">High Sensitivity Mode</div>
                </div>
            </div>

            <!-- Error Message Box -->
            <div id="error-box" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-900/90 p-6 rounded-xl text-center pointer-auto w-64 border border-red-500">
                <i data-lucide="video-off" class="w-10 h-10 mx-auto text-red-200 mb-2"></i>
                <p class="text-white font-bold mb-2">កាមេរ៉ាមិនដំណើរការ</p>
                <p class="text-xs text-red-200 mb-4">សូមពិនិត្យមើលថាអ្នកបានចុច "Allow" ឬ "អនុញ្ញាត" ឱ្យប្រើកាមេរ៉ា។</p>
                <button onclick="startCamera()" class="bg-white text-red-900 px-4 py-2 rounded-full text-sm font-bold w-full">ព្យាយាមម្តងទៀត</button>
            </div>

            <!-- Controls -->
            <div class="flex justify-center items-center gap-8 pointer-auto pb-6">
                
                <!-- Switch Camera -->
                <button onclick="switchCamera()" class="bg-gray-800/80 p-4 rounded-full active:scale-90 transition border border-gray-600">
                    <i data-lucide="refresh-ccw" class="w-6 h-6 text-white"></i>
                </button>

                <!-- Pause/Play (Freeze) -->
                <button id="action-btn" onclick="togglePlay()" class="bg-purple-600 p-6 rounded-full active:scale-90 transition shadow-[0_0_20px_rgba(147,51,234,0.5)] border-2 border-white/20">
                    <i id="action-icon" data-lucide="pause" class="w-8 h-8 text-white"></i>
                </button>

            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('thermal-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const errorBox = document.getElementById('error-box');
        const actionIcon = document.getElementById('action-icon');
        
        let stream = null;
        let isRunning = false;
        let facingMode = 'environment'; // ចាប់ផ្តើមដោយកាមេរ៉ាក្រោយ (ល្អសម្រាប់ Night Vision)

        // Palette ពណ៌ (Ironbow)
        const palette = [];
        function initPalette() {
            // បង្កើតពណ៌ពី ស្វាយ -> ក្រហម -> លឿង -> ស
            for (let i = 0; i < 256; i++) {
                // HSL to RGB conversion simplified for Heatmap effect
                // Hue វិលពី 270 (Purple) ទៅ 60 (Yellow)
                // យើងប្រើវិធីសាមញ្ញដោយកំណត់ពណ៌
                let r, g, b;
                const val = i / 255;
                
                if (val < 0.3) { // ងងឹត (ស្វាយ)
                    r = val * 100; 
                    g = 0; 
                    b = 50 + val * 200;
                } else if (val < 0.6) { // កណ្តាល (ក្រហម/ស្វាយ)
                    r = 100 + (val-0.3)*400; 
                    g = 0; 
                    b = 100 - (val-0.3)*300;
                } else { // ភ្លឺ (លឿង/ស)
                    r = 255; 
                    g = (val-0.6)*600; 
                    b = (val-0.6)*200;
                }
                
                // Clamp values 0-255
                palette[i] = [
                    Math.min(255, Math.max(0, r)), 
                    Math.min(255, Math.max(0, g)), 
                    Math.min(255, Math.max(0, b))
                ];
            }
        }
        initPalette();

        async function startCamera() {
            errorBox.classList.add('hidden');
            
            // បិទកាមេរ៉ាចាស់សិន
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Constraints សាមញ្ញបំផុតដើម្បីកុំឱ្យ Error
            const constraints = {
                video: {
                    facingMode: facingMode
                },
                audio: false
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // ចាំរហូតដល់វីដេអូលេងបាន
                video.onloadedmetadata = () => {
                    video.play();
                    isRunning = true;
                    requestAnimationFrame(processFrame);
                };
            } catch (err) {
                console.error("Camera Error:", err);
                errorBox.classList.remove('hidden');
            }
        }

        function switchCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            startCamera();
        }

        function togglePlay() {
            if (video.paused) {
                video.play();
                isRunning = true;
                actionIcon.setAttribute('data-lucide', 'pause');
                requestAnimationFrame(processFrame);
            } else {
                video.pause();
                isRunning = false;
                actionIcon.setAttribute('data-lucide', 'play');
            }
            lucide.createIcons();
        }

        function processFrame() {
            if (!isRunning || video.paused || video.ended) return;

            // កំណត់ទំហំ Canvas តាមវីដេអូ (តូចល្មមដើម្បីលឿន)
            const w = 200; // Low resolution for "blocky" thermal look + performance
            const h = w * (video.videoHeight / video.videoWidth);
            
            canvas.width = w;
            canvas.height = h;

            // គូររូបវីដេអូដាក់ Canvas
            ctx.drawImage(video, 0, 0, w, h);
            
            // យកទិន្នន័យ Pixel
            const frame = ctx.getImageData(0, 0, w, h);
            const data = frame.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // រូបមន្តពន្លឺ
                let brightness = (r + g + b) / 3;

                // *** NIGHT VISION LOGIC ***
                // បង្កើនពន្លឺ (Gain) ខ្លាំងៗសម្រាប់កន្លែងងងឹត
                brightness = brightness * 2.5; 
                
                // បន្ថែម Noise តិចៗដើម្បីឱ្យដូចកាមេរ៉ាពិត
                brightness += (Math.random() - 0.5) * 10;

                if (brightness > 255) brightness = 255;
                if (brightness < 0) brightness = 0;
                
                const index = Math.floor(brightness);
                const color = palette[index];

                data[i] = color[0];     // R
                data[i + 1] = color[1]; // G
                data[i + 2] = color[2]; // B
            }

            ctx.putImageData(frame, 0, 0);
            requestAnimationFrame(processFrame);
        }

        // ចាប់ផ្តើម
        window.addEventListener('load', startCamera);

        // ដោះស្រាយបញ្ហាអេក្រង់ទូរស័ព្ទតូច/ធំ
        window.addEventListener('resize', () => {
            if(isRunning) startCamera();
        });

    </script>
</body>
</html>